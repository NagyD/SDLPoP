name: Build Release

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libsdl2-dev \
          libsdl2-image-dev \
          wget \
          file \
          fuse
    
    - name: Build SDLPoP
      working-directory: src
      run: |
        make clean
        make all
    
    - name: Verify build output
      run: |
        if [ ! -f prince ]; then
          echo "Error: prince binary not found in root directory"
          echo "Contents of root directory:"
          ls -la
          echo "Contents of src directory:"
          ls -la src/
          exit 1
        fi
        echo "✓ Build successful: prince binary found"
        file prince
    
    - name: Download linuxdeploy
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
    
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy binary (Makefile outputs to ../prince, which is root)
        if [ ! -f prince ]; then
          echo "Error: prince binary not found"
          exit 1
        fi
        cp prince AppDir/usr/bin/
        chmod +x AppDir/usr/bin/prince
        
        # Copy data directory
        if [ ! -d data ]; then
          echo "Error: data directory not found"
          exit 1
        fi
        cp -r data AppDir/usr/bin/
        
        # Copy config file (optional)
        if [ -f SDLPoP.ini ]; then
          cp SDLPoP.ini AppDir/usr/bin/
        else
          echo "# SDLPoP Configuration" > AppDir/usr/bin/SDLPoP.ini
        fi
        
        # Copy README (optional)
        if [ -f doc/Readme.txt ]; then
          cp doc/Readme.txt AppDir/usr/bin/README.txt
        else
          echo "SDLPoP" > AppDir/usr/bin/README.txt
        fi
        
        echo "✓ AppDir structure created successfully"
    
    - name: Create desktop file
      run: |
        cat > AppDir/usr/share/applications/sdlpop.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=SDLPoP
        Comment=Prince of Persia port
        Exec=prince
        Icon=sdlpop
        Categories=Game;
        EOF
    
    - name: Copy icon (if exists)
      run: |
        if [ -f data/icon.png ]; then
          cp data/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/sdlpop.png
        fi
    
    - name: Create AppImage
      env:
        VERSION: ${{ github.ref_name }}
      run: |
        export VERSION=${VERSION#v}  # Remove 'v' prefix if present
        export ARCH=x86_64
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --executable AppDir/usr/bin/prince \
          --desktop-file AppDir/usr/share/applications/sdlpop.desktop \
          --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/sdlpop.png \
          --output appimage
        
        # Find the created AppImage and rename if needed
        APPIMAGE=$(ls SDLPoP-*.AppImage 2>/dev/null | head -n 1)
        TARGET_NAME="SDLPoP-${VERSION}-x86_64.AppImage"
        
        if [ -z "$APPIMAGE" ]; then
          echo "Error: No AppImage file found"
          exit 1
        fi
        
        if [ "$APPIMAGE" != "$TARGET_NAME" ]; then
          echo "Renaming $APPIMAGE to $TARGET_NAME"
          mv "$APPIMAGE" "$TARGET_NAME"
        else
          echo "AppImage already has correct name: $TARGET_NAME"
        fi
        
        # Verify the final file exists
        if [ ! -f "$TARGET_NAME" ]; then
          echo "Error: Final AppImage file not found: $TARGET_NAME"
          exit 1
        fi
        echo "✓ Created $TARGET_NAME"
        ls -lh "$TARGET_NAME"
    
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: SDLPoP-Linux-AppImage
        path: SDLPoP-*.AppImage
        retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install MSYS2 and dependencies
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-SDL2
          mingw-w64-x86_64-SDL2_image
          make
    
    - name: Build SDLPoP
      shell: msys2 {0}
      working-directory: src
      run: |
        export SDL2=/mingw64
        export SDL2INC=/mingw64/include/SDL2
        export SDL2LIB=/mingw64/lib
        export PATH=/mingw64/bin:$PATH
        
        # Compile all source files
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c main.c -o main.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c data.c -o data.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg000.c -o seg000.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg001.c -o seg001.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg002.c -o seg002.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg003.c -o seg003.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg004.c -o seg004.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg005.c -o seg005.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg006.c -o seg006.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg007.c -o seg007.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg008.c -o seg008.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seg009.c -o seg009.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c seqtbl.c -o seqtbl.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c replay.c -o replay.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c options.c -o options.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c lighting.c -o lighting.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c screenshot.c -o screenshot.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c menu.c -o menu.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c midi.c -o midi.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c opl3.c -o opl3.o
        gcc -Wall -std=c99 -O3 -ffast-math -I"$SDL2INC" -I"$SDL2INC/../include" -c stb_vorbis.c -o stb_vorbis.o
        
        # Link
        gcc -mwindows main.o data.o seg000.o seg001.o seg002.o seg003.o seg004.o seg005.o seg006.o seg007.o seg008.o seg009.o seqtbl.o replay.o options.o lighting.o screenshot.o menu.o midi.o opl3.o stb_vorbis.o -L"$SDL2LIB" -Wl,--whole-archive -lSDL2main -Wl,--no-whole-archive -lSDL2 -lSDL2_image -lm -o ../prince.exe
    
    - name: Verify build output
      shell: msys2 {0}
      run: |
        if [ ! -f prince.exe ]; then
          echo "Error: prince.exe not found in root directory"
          echo "Contents of root directory:"
          ls -la
          echo "Contents of src directory:"
          ls -la src/
          exit 1
        fi
        echo "✓ Build successful: prince.exe found"
        ls -lh prince.exe
    
    - name: Create release package
      shell: msys2 {0}
      working-directory: .
      run: |
        version="${{ github.ref_name }}"
        version=${version#v}  # Remove 'v' prefix if present
        zipName="SDLPoP-${version}-Windows-x86_64.zip"
        
        # Create release directory
        mkdir -p release
        
        # Verify and copy executable
        if [ ! -f prince.exe ]; then
          echo "Error: prince.exe not found"
          exit 1
        fi
        cp prince.exe release/
        echo "✓ Copied prince.exe"
        
        # Verify and copy DLLs from MSYS2 installation
        if [ ! -f /mingw64/bin/SDL2.dll ]; then
          echo "Error: SDL2.dll not found at /mingw64/bin/SDL2.dll"
          echo "Searching for SDL2.dll..."
          find /mingw64 -name "SDL2.dll" 2>/dev/null || true
          exit 1
        fi
        if [ ! -f /mingw64/bin/SDL2_image.dll ]; then
          echo "Error: SDL2_image.dll not found at /mingw64/bin/SDL2_image.dll"
          echo "Searching for SDL2_image.dll..."
          find /mingw64 -name "SDL2_image.dll" 2>/dev/null || true
          exit 1
        fi
        cp /mingw64/bin/SDL2.dll release/
        cp /mingw64/bin/SDL2_image.dll release/
        echo "✓ Copied SDL2 DLLs"
        
        # Verify and copy data directory
        if [ ! -d data ]; then
          echo "Error: data directory not found"
          exit 1
        fi
        cp -r data release/
        echo "✓ Copied data directory"
        
        # Copy config file (optional)
        if [ -f SDLPoP.ini ]; then
          cp SDLPoP.ini release/
          echo "✓ Copied SDLPoP.ini"
        else
          echo "# SDLPoP Configuration" > release/SDLPoP.ini
          echo "✓ Created default SDLPoP.ini"
        fi
        
        # Copy README (optional)
        if [ -f doc/Readme.txt ]; then
          cp doc/Readme.txt release/README.txt
          echo "✓ Copied README.txt"
        fi
        
        # Create zip using zip command (avoids PowerShell nesting issues)
        cd release
        zip -r "../$zipName" . -q
        cd ..
        
        if [ ! -f "$zipName" ]; then
          echo "Error: Failed to create zip file"
          exit 1
        fi
        
        echo "✓ Created $zipName"
        ls -lh "$zipName"
    
    - name: Upload Windows zip artifact
      uses: actions/upload-artifact@v4
      with:
        name: SDLPoP-Windows-x86_64
        path: SDLPoP-*.zip
        retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: SDLPoP-Linux-AppImage
        path: artifacts/linux
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: SDLPoP-Windows-x86_64
        path: artifacts/windows
    
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/linux/*
          artifacts/windows/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

